<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
		<title>考勤-统计</title>
		<link rel="stylesheet" href="../../css/weui.css"/>
		<link rel="stylesheet" href="../../css/example.css"/>
		<link rel="stylesheet" href="../../css/iconfont/iconfont.css">
		<link rel="stylesheet" href="../../css/attendance.css">
	</head>
	<body>
		<div class="container adc-detail adc-statistics" id="container">
			<div class="card-list">
				<div class="weui-panel">
					<div class="weui-panel__bd">
						<a href="javascript:void(0);" class="weui-media-box weui-media-box_appmsg">
							<div class="card-top weui-flex">
								<div class="weui-media-box__hd">
									<img class="weui-media-box__thumb" src="../../img/itmc.png" alt="">
								</div>
								<div class="weui-media-box__bd">
									<p class="weui-media-box__desc">
										<label>
											<i class="iconfont icon-single-person"></i><span>姓名:</span>
										</label>
										<span>谢朝阳</span>
									</p>
									<p class="weui-media-box__desc">
										<label>
											<i class="iconfont icon-renyuan"></i><span>部门:</span>
										</label>
										<span>研发部</span>
									</p>
									<p class="weui-media-box__desc">
										<label>
											<i class="iconfont icon-zhengjian"></i><span>岗位:</span>
										</label>
										<span>JAVA开发</span>
									</p>
									<p class="weui-media-box__desc">
										<label>
											<i class="iconfont icon-chengshi1"></i><span>城市:</span>
										</label>
										<span>北京</span>
									</p>
								</div>
							</div>
						</a>
					</div>
				</div>
			</div>
			<div class="time-box">
				<div class="weui-flex date-top">
					<div class="weui-flex__item prev-month"><div class="placeholder"><i class="iconfont icon-fangxiang1"></i></div></div>
					<div class="time-date" data-year="2020" data-month="4">2020年4月</div>
					<div class="weui-flex__item next-month"><div class="placeholder"><i class="iconfont icon-fangxiang"></i></div></div>
				</div>
				<div class="weui-grids time-week">
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>日</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>一</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>二</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>三</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>四</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>五</span></p></a>
					<a href="javascript:" class="weui-grid"><p class="weui-grid__label"><span>六</span></p></a>
				</div>
				<div class="weui-grids exact-date">
					<a href="javascript:" class="weui-grid prev-grid disabled">
						<p class="weui-grid__label">
							<span><em>31</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid">
						<p class="weui-grid__label">
							<span><em>1</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid">
						<p class="weui-grid__label">
							<span><em>2</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid bg-normal">
						<p class="weui-grid__label">
							<span><em>3</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid bg-abnormal">
						<p class="weui-grid__label">
							<span><em>4</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid bg-late">
						<p class="weui-grid__label">
							<span><em>5</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid current-chose">
						<p class="weui-grid__label">
							<span><em>6</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid">
						<p class="weui-grid__label">
							<span><em>7</em></span>
						</p>
					</a>
					<a href="javascript:" class="weui-grid next-grid disabled">
						<p class="weui-grid__label">
							<span><em>1</em></span>
						</p>
					</a>
				</div>
				<div class="explain">
					<span class="bg-normal"><em></em>正常打卡</span>
					<span class="bg-abnormal"><em></em>异常</span>
					<span class="bg-late"><em></em>迟到、旷工</span>
				</div>
			</div>
			<div class="weui-panel attendance-info">
				<div class="weui-panel__hd"><span class="chose-date">2020-04-10</span><span class="punch-clock">正常打卡</span></div>
				<div class="weui-panel__bd">
					<div class="weui-media-box weui-media-box_small-appmsg">
						<div class="weui-cells">
							<a class="weui-cell weui-cell_active weui-cell_access weui-cell_example" href="javascript:">
								<div class="weui-cell__hd"></div>
								<div class="weui-cell__bd weui-cell_primary">
									<p><i class="iconfont icon-dingweiweizhi"></i>远洋时代广场</p>
								</div>
								<span class="weui-cell__ft">08:30</span>
							</a>
							<a class="weui-cell weui-cell_active weui-cell_access weui-cell_example" href="javascript:">
								<div class="weui-cell__hd"></div>
								<div class="weui-cell__bd weui-cell_primary">
									<p><i class="iconfont icon-dingweiweizhi"></i>远洋时代广场</p>
								</div>
								<span class="weui-cell__ft">08:30</span>
							</a>
							<a class="weui-cell weui-cell_active weui-cell_access weui-cell_example" href="javascript:">
								<div class="weui-cell__hd"></div>
								<div class="weui-cell__bd weui-cell_primary">
									<p><i class="iconfont icon-jiabanxuanzhong"></i>加班时间</p>
								</div>
								<span class="weui-cell__ft">1</span>
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="js_dialog" id="iosDialog2" style="opacity: 0; display: none;">
				<div class="weui-mask"></div>
				<div class="weui-dialog">
					<div class="weui-dialog__bd"></div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../js/zepto.min.js"></script>
	<script src="../../js/weui.min.js"></script>
	<script>
		$(function() {
			// 初始化
			var dateStr = "2020-4-1";
			// 1-正常打卡，2-异常，3-迟到、旷工
			punchClockList = [1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1]
			renderDate(dateStr, punchClockList);
			// 上月
			$(".prev-month").on("click", function() {
				var year = +$(".time-date").data("year");
				var month = +$(".time-date").data("month");
				month -= 1;
				if(month < 1) {
					month = 12;
					year -= 1;
				}
				var dateStr = year + "-" + month + "-" + 1;
				$(".time-date").text(year+"年"+month+"月").attr({
					"data-year": year,
					"data-month": month
				});
				renderDate(dateStr, punchClockList);
			})
			// 下月
			$(".next-month").on("click", function() {
				var year = +$(".time-date").data("year");
				var month = +$(".time-date").data("month");
				month += 1;
				if(month > 12) {
					month = 1;
					year += 1;
				}
				var flag = queryLimit(year, month);
				if(flag == false) {
					$('#iosDialog2').find(".weui-dialog__bd").text("可查询最新日期为："+year+"年"+(month-1)+"月");
					$('#iosDialog2').fadeIn(200);
					setTimeout(function() {
						$('#iosDialog2').fadeOut(200);
					}, 1500)
					return;
				}
				var dateStr = year + "-" + month + "-" + 1;
				$(".time-date").text(year+"年"+month+"月").attr({
					"data-year": year,
					"data-month": month
				});
				renderDate(dateStr, punchClockList);
			})
			
			// 点击日期
			$(".exact-date").on("click", "a", function() {
				var year = +$(".time-date").data("year");
				var month = +$(".time-date").data("month");
				var day = +$(this).find("em").text().trim();
				if($(this).hasClass("disabled")) {
					return;
				}else if($(this).hasClass("prev-grid")) {
					// 上月
					month -= 1;
					if(month < 1) {
						month = 12;
						year -= 1;
					}
					var dateStr = year + "-" + month + "-" + day;
					$(".time-date").text(year+"年"+month+"月").attr({
						"data-year": year,
						"data-month": month
					});
					renderDate(dateStr, punchClockList);
				}else if($(this).hasClass("next-grid")) {
					// 下月
					month += 1;
					if(month > 12) {
						month = 1;
						year += 1;
					}
					var flag = queryLimit(year, month);
					if(flag == false) {
						$('#iosDialog2').find(".weui-dialog__bd").text("可查询最新日期为："+year+"年"+(month-1)+"月");
						$('#iosDialog2').fadeIn(200);
						setTimeout(function() {
							$('#iosDialog2').fadeOut(200);
						}, 1500)
						return;
					}
					var dateStr = year + "-" + month + "-" + day;
					$(".time-date").text(year+"年"+month+"月").attr({
						"data-year": year,
						"data-month": month
					});
					renderDate(dateStr, punchClockList);
				}else {
					$(this).addClass("current-chose").siblings().removeClass("current-chose");
				}
			})
		})
		// 月份渲染
		function renderDate(dateStr, punchClockList) {
			var loading = weui.loading('正在加载', {
			    className: 'custom-classname'
			});
			var reg = /[1-9][0-9]*/g;
			var dateArr = dateStr.match(reg);
			var year = dateArr[0];
			var month = dateArr[1] - 1;
			var day = dateArr[2]
			
			var currDate = new Date(year, month, 1);
			var currWeek = currDate.getDay();	// 当月1号星期几
			// console.log(currWeek);
			
			// 上月
			var prevList = [];	// 渲染日期数组
			currDate.setDate(0);
			var prevDay = currDate.getDate();
			var prevMonth = currDate.getMonth();
			// console.log(prevDay, currWeek);
			for(var i=currWeek-1; i>=0; i--) {
				prevList.unshift(prevDay);
				prevDay--;
			}
			// console.log(prevList);
			// 当月
			var list = [];
			currDate.setDate(1);
			currDate.setMonth(prevMonth+2);
			currDate.setDate(0);	// 当月最后一天
			var currLastDay = currDate.getDate();
			for(var i=1; i<=currLastDay; i++) {
				list.push(i);
			}
			// 下月
			var nextList = [];
			currWeek = currDate.getDay();	// 当月最后一天星期几
			// console.log(currWeek);
			var nextDay = 6 - currWeek;
			
			var week = Math.ceil((prevList.length + list.length + nextList.length)/7);
			// 极限情况下，可显示6周
			if(week<6) {
				nextDay += 7*(6-week);
			}
			for(var i=1; i<=nextDay; i++) {
				nextList.push(i);
			}
			// console.log(prevList);
			// console.log(list);
			// console.log(nextList);
			var str = "";
			$(prevList).each(function(index, item) {
				str += `<a href="javascript:" class="weui-grid prev-grid"><p class="weui-grid__label"><span><em>${item}</em></span></p></a>`;
			})
			$(list).each(function(index, item) {
				var className = (item==day? " current-chose " : "");
				if(punchClockList[index] == 1) {
					className += " bg-normal ";
				}else if(punchClockList[index] == 2) {
					className += " bg-abnormal ";
				}else if(punchClockList[index] == 3) {
					className += " bg-late ";
				}
				str += `<a href="javascript:" class="weui-grid ${className}"><p class="weui-grid__label"><span><em>${item}</em></span></p></a>`;
			})
			$(nextList).each(function(index, item) {
				str += `<a href="javascript:" class="weui-grid next-grid"><p class="weui-grid__label"><span><em>${item}</em></span></p></a>`;
			})
			$(".exact-date").empty().append(str);
			loading.hide(function() {
				 // console.log('`loading` has been hidden');
			 });
		}
		// 查询限制
		function queryLimit(year, month) {
			var nowDate = new Date();
			var nowYear = nowDate.getFullYear();
			var nowMonth = nowDate.getMonth() + 1;
			if(year > nowYear) {
				return false;
			}else if(year < nowYear) {
				return true;
			}else {
				if(+month < nowMonth) {
					return true;
				}else {
					return false;
				}
			}
		}
	</script>
</html>
